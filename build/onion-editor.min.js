/*! onion-editor 2013-07-15 */
function Sanitize(){var a,b;for(b=arguments[0]||{},this.config={},this.config.elements=b.elements?b.elements:[],this.config.attributes=b.attributes?b.attributes:{},this.config.attributes[Sanitize.ALL]=this.config.attributes[Sanitize.ALL]?this.config.attributes[Sanitize.ALL]:[],this.config.allow_comments=b.allow_comments?b.allow_comments:!1,this.allowed_elements={},this.config.protocols=b.protocols?b.protocols:{},this.config.add_attributes=b.add_attributes?b.add_attributes:{},this.dom=b.dom?b.dom:document,a=0;a<this.config.elements.length;a++)this.allowed_elements[this.config.elements[a]]=!0;if(this.config.remove_element_contents={},this.config.remove_all_contents=!1,b.remove_contents)if(b.remove_contents instanceof Array)for(a=0;a<b.remove_contents.length;a++)this.config.remove_element_contents[b.remove_contents[a]]=!0;else this.config.remove_all_contents=!0;this.transformers=b.transformers?b.transformers:[]}!function(a){"use strict";a.EditorModules=[];var b=b||function(b){function c(b){for(var c=0;c<a.EditorModules.length;c++)g.push(new a.EditorModules[c](e,b));$(b.element).append('<div class="editor-wrapper">                            <div class="editor" contenteditable="true" spellcheck="true">                                <p></p>                            </div>                            <div class="document-tools toolbar"></div>                            <div class="paragraph-tools toolbar"></div>                            <div class="selection-tools toolbar"></div>                        </div>'),d=new Sanitize(b.sanitize),e.emit("init"),$(b.element).bind("click",function(a){e.emit("click",a)}).bind("keydown",function(a){if(13===a.keyCode);else if(8===a.keyCode){var b=window.getSelection();"P"===b.focusNode.tagName&&1==$(".editor>*").length&&a.preventDefault()}e.emit("keydown",a)}).bind("keyup",function(a){e.emit("keyup",a)}).bind("paste",function(a){var b=a.originalEvent.clipboardData.getData("text/html"),c=document.createDocumentFragment();c.appendChild(document.createElement("div")),c.childNodes[0].innerHTML=b;for(var f=d.clean_node(c.childNodes[0]),g="",h=0;h<f.childNodes.length;h++){var i=f.childNodes[h];3==i.nodeType?g+=i.nodeValue:1==i.nodeType&&""==!f.childNodes[h].innerText&&(g+=f.childNodes[h].outerHTML)}if(window.getSelection){var j=window.getSelection();if(j.getRangeAt&&j.rangeCount){var k=j.getRangeAt(0);k.deleteContents(),document.execCommand("InsertHTML",!1,g)}}a.preventDefault(),e.emit("paste")})}var d,e=this,f={element:null,sanitize:{elements:["b","em","i","strong","u","p","blockquote","a","ul","ol","li","br"],attributes:{a:["href","title"]},remove_contents:["script","style"],protocols:{a:{href:["http","https","mailto"]}}}},g=[],h={enableEvents:function(a){a.__listeners__=a.__listeners__||{},a.on=function(b,c){var d=a.__listeners__[b]||(a.__listeners__[b]=[]);d.push(c)},a.off=function(b,c){for(var d=a.__listeners__[b]||[],e=[],f=0,g=d.length;g>f;f++)d[f]!==c&&e.push(d[f]);a.__listeners__[b]=e},a.emit=function(b){for(var c=Array.prototype.slice.call(arguments,1),d=a.__listeners__[b]||[],e=0,f=d.length;f>e;e++)try{d[e].apply(null,c)}catch(g){}}}};h.enableEvents(e),e.setContent=function(a){$(b.element).find(".editor").html(a)},b=$.extend(f,b),c(b)};a.Editor=b}(this),function(a){"use strict";var b=b||function(a,b){function c(){setTimeout(function(){if(document.getSelection().focusNode&&$(document.getSelection().focusNode.parentNode).parents(".editor"))if("Range"===document.getSelection().type){var a=$($(document.getSelection().focusNode)).parents("p").position().top-50;$(".selection-tools").css({top:a}),$(".selection-tools").show(),$(".paragraph-tools").hide()}else if("Caret"===document.getSelection().type){var a=$($(document.getSelection().focusNode)).parents("p").position().top;$(".paragraph-tools").css({top:a}),$(".selection-tools").hide(),$(".paragraph-tools").show()}else $(".selection-tools,.paragraph-tools").hide();else $(".selection-tools,.paragraph-tools").hide()},5)}function d(){$(b.element).find(".document-tools").html(b.toolbar.documentTools),$(b.element).find(".paragraph-tools").html(b.toolbar.paragraphTools),$(b.element).find(".selection-tools").html(b.toolbar.selectionTools),e.toolbarElement=$(b.element).find(".toolbar"),e.toolbarElement.click(function(b){console.log(b),a.emit("toolbar:click:"+$(b.target).attr("name"))}),a.emit("toolbar:ready")}var e=this;a.on("init",d),$(document).bind("selectionchange",c)};a.EditorModules.push(b)}(this),function(a){"use strict";var b=b||function(a,b){function c(){document.execCommand("BOLD")}function d(){document.execCommand("ITALIC")}function e(){document.execCommand("UNDERLINE")}function f(){document.execCommand("STRIKETHROUGH")}function g(){document.execCommand("superscript")}function h(){document.execCommand("subscript")}function i(){document.execCommand("insertUnorderedList",null,null)}function j(){document.execCommand("insertOrderedList",null,null)}function k(){$(b.element).find(".editor").toggleClass("visualize")}key("⌘+b, ctrl+b",c),key("⌘+i, ctrl+i",d),key("⌘+u, ctrl+u",e),a.on("toolbar:click:italic",d),a.on("toolbar:click:bold",c),a.on("toolbar:click:underline",e),a.on("toolbar:click:strikethrough",f),a.on("toolbar:click:superscript",h),a.on("toolbar:click:subscript",g),a.on("toolbar:click:unorderedlist",i),a.on("toolbar:click:orderedlist",j),a.on("toolbar:click:visualize",k)};a.EditorModules.push(b)}(this),function(a){"use strict";var b=b||function(a){function b(){var a=window.getSelection();return 0==a.focusOffset?-1:a.focusNode.textContent.substr(a.focusOffset-1,1).charCodeAt(0)}function c(a){if(222==a.keyCode){var c,d=b();switch(d){case-1:case 32:case 160:c=a.shiftKey?"&ldquo;":"&lsquo;";break;default:c=a.shiftKey?"&rdquo;":"&rsquo;"}document.execCommand("InsertHTML",!1,c),a.preventDefault()}}a.on("keydown",c)};a.EditorModules.push(b)}(this),Sanitize.REGEX_PROTOCOL=/^([A-Za-z0-9\+\-\.\&\;\*\s]*?)(?:\:|&*0*58|&*x0*3a)/i,Sanitize.RELATIVE="__relative__",Sanitize.prototype.clean_node=function(a){function b(a,b){var c;for(c=0;c<b.length;c++)if(b[c]==a)return c;return-1}function c(){var a,b,c=[],d={};for(a=0;a<arguments.length;a++)if(arguments[a]&&arguments[a].length)for(b=0;b<arguments[a].length;b++)d[arguments[a][b]]||(d[arguments[a][b]]=!0,c.push(arguments[a][b]));return c}function d(a){var b;switch(a.nodeType){case 1:e.call(this,a);break;case 3:b=a.cloneNode(!1),this.current_element.appendChild(b);break;case 5:b=a.cloneNode(!1),this.current_element.appendChild(b);break;case 8:this.config.allow_comments&&(b=a.cloneNode(!1),this.current_element.appendChild(b));break;default:console&&console.log&&console.log("unknown node type",a.nodeType)}}function e(a){var e,g,h,i,j,k,l,m,n,o,p=f.call(this,a);if(a=p.node,h=a.nodeName.toLowerCase(),g=this.current_element,this.allowed_elements[h]||p.whitelist){this.current_element=this.dom.createElement(a.nodeName),g.appendChild(this.current_element);var q=this.config.attributes;for(i=c(q[h],q.__ALL__,p.attr_whitelist),e=0;e<i.length;e++)k=i[e],j=a.attributes[k],j&&(o=!0,this.config.protocols[h]&&this.config.protocols[h][k]&&(m=this.config.protocols[h][k],n=j.nodeValue.toLowerCase().match(Sanitize.REGEX_PROTOCOL),o=n?-1!=b(n[1],m):-1!=b(Sanitize.RELATIVE,m)),o&&(l=document.createAttribute(k),l.value=j.nodeValue,this.current_element.setAttributeNode(l)));if(this.config.add_attributes[h])for(k in this.config.add_attributes[h])l=document.createAttribute(k),l.value=this.config.add_attributes[h][k],this.current_element.setAttributeNode(l)}else if(-1!=b(a,this.whitelist_nodes)){for(this.current_element=a.cloneNode(!0);this.current_element.childNodes.length>0;)this.current_element.removeChild(this.current_element.firstChild);g.appendChild(this.current_element)}if(!this.config.remove_all_contents&&!this.config.remove_element_contents[h])for(e=0;e<a.childNodes.length;e++)d.call(this,a.childNodes[e]);this.current_element.normalize&&this.current_element.normalize(),this.current_element=g}function f(a){var d,e,f,g={attr_whitelist:[],node:a,whitelist:!1};for(d=0;d<this.transformers.length;d++)if(f=this.transformers[d]({allowed_elements:this.allowed_elements,config:this.config,node:a,node_name:a.nodeName.toLowerCase(),whitelist_nodes:this.whitelist_nodes,dom:this.dom}),null!=f){if("object"!=typeof f)throw new Error("transformer output must be an object or null");if(f.whitelist_nodes&&f.whitelist_nodes instanceof Array)for(e=0;e<f.whitelist_nodes.length;e++)-1==b(f.whitelist_nodes[e],this.whitelist_nodes)&&this.whitelist_nodes.push(f.whitelist_nodes[e]);g.whitelist=f.whitelist?!0:!1,f.attr_whitelist&&(g.attr_whitelist=c(g.attr_whitelist,f.attr_whitelist)),g.node=f.node?f.node:g.node}return g}var g=this.dom.createDocumentFragment();for(this.current_element=g,this.whitelist_nodes=[],i=0;i<a.childNodes.length;i++)d.call(this,a.childNodes[i]);return g.normalize&&g.normalize(),g},"function"==typeof define&&define("sanitize",[],function(){return Sanitize}),function(a){function b(a,b){for(var c=a.length;c--;)if(a[c]===b)return c;return-1}function c(a){for(p in r)r[p]=a[x[p]]}function d(a,d){var e,f,h,i,j;if(e=a.keyCode,-1==b(w,e)&&w.push(e),(93==e||224==e)&&(e=91),e in r){r[e]=!0;for(h in t)t[h]==e&&(g[h]=!0)}else if(c(a),g.filter.call(this,a)&&e in q)for(i=0;i<q[e].length;i++)if(f=q[e][i],f.scope==d||"all"==f.scope){j=f.mods.length>0;for(h in r)(!r[h]&&b(f.mods,+h)>-1||r[h]&&-1==b(f.mods,+h))&&(j=!1);(0!=f.mods.length||r[16]||r[18]||r[17]||r[91])&&!j||f.method(a,f)===!1&&(a.preventDefault?a.preventDefault():a.returnValue=!1,a.stopPropagation&&a.stopPropagation(),a.cancelBubble&&(a.cancelBubble=!0))}}function e(a){var c,d=a.keyCode,e=b(w,d);if(e>=0&&w.splice(e,1),(93==d||224==d)&&(d=91),d in r){r[d]=!1;for(c in t)t[c]==d&&(g[c]=!1)}}function f(){for(p in r)r[p]=!1;for(p in t)g[p]=!1}function g(a,b,c){var d,e,f,g;for(void 0===c&&(c=b,b="all"),a=a.replace(/\s/g,""),d=a.split(","),""==d[d.length-1]&&(d[d.length-2]+=","),f=0;f<d.length;f++){if(e=[],a=d[f].split("+"),a.length>1){for(e=a.slice(0,a.length-1),g=0;g<e.length;g++)e[g]=t[e[g]];a=[a[a.length-1]]}a=a[0],a=v(a),a in q||(q[a]=[]),q[a].push({shortcut:d[f],scope:b,method:c,key:d[f],mods:e})}}function h(a){return"string"==typeof a&&(a=v(a)),-1!=b(w,a)}function i(){return w.slice(0)}function j(a){var b=(a.target||a.srcElement).tagName;return!("INPUT"==b||"SELECT"==b||"TEXTAREA"==b)}function k(a){s=a||"all"}function l(){return s||"all"}function m(a){var b,c,d;for(b in q)for(c=q[b],d=0;d<c.length;)c[d].scope===a?c.splice(d,1):d++}function n(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,function(){c(window.event)})}function o(){var b=a.key;return a.key=y,b}var p,q={},r={16:!1,18:!1,17:!1,91:!1},s="all",t={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,command:91},u={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},v=function(a){return u[a]||a.toUpperCase().charCodeAt(0)},w=[];for(p=1;20>p;p++)t["f"+p]=111+p;var x={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(p in t)g[p]=!1;n(document,"keydown",function(a){d(a,s)}),n(document,"keyup",e),n(window,"focus",f);var y=a.key;a.key=g,a.key.setScope=k,a.key.getScope=l,a.key.deleteScope=m,a.key.filter=j,a.key.isPressed=h,a.key.getPressedKeyCodes=i,a.key.noConflict=o,"undefined"!=typeof module&&(module.exports=key)}(this);