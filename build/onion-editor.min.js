/*! onion-editor 2014-04-17 */
!function(){function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype,e=this,f=e.EventEmitter;d.getListeners=function(a){var b,c,d=this._getEvents();if(a instanceof RegExp){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if(a instanceof RegExp)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g=this.getListenersAsObject(a);for(e in g)if(g.hasOwnProperty(e))for(d=g[e].length;d--;)c=g[e][d],c.once===!0&&this.removeListener(a,c.listener),f=c.listener.apply(this,b||[]),f===this._getOnceReturnValue()&&this.removeListener(a,c.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},a.noConflict=function(){return e.EventEmitter=f,a},"function"==typeof define&&define.amd?define("event-emitter",[],function(){return a}):"object"==typeof module&&module.exports?module.exports=a:this.EventEmitter=a}.call(this),define("lodash-modern/internals/isNative",[],function(){function a(a){return"function"==typeof a&&d.test(a)}var b=Object.prototype,c=b.toString,d=RegExp("^"+String(c).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");return a}),define("lodash-modern/internals/objectTypes",[],function(){var a={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1};return a}),define("lodash-modern/objects/isObject",["../internals/objectTypes"],function(a){function b(b){return!(!b||!a[typeof b])}return b}),define("lodash-modern/internals/shimKeys",["./objectTypes"],function(a){var b=Object.prototype,c=b.hasOwnProperty,d=function(b){var d,e=b,f=[];if(!e)return f;if(!a[typeof b])return f;for(d in e)c.call(e,d)&&f.push(d);return f};return d}),define("lodash-modern/objects/keys",["../internals/isNative","./isObject","../internals/shimKeys"],function(a,b,c){var d=a(d=Object.keys)&&d,e=d?function(a){return b(a)?d(a):[]}:c;return e}),define("lodash-modern/objects/defaults",["./keys","../internals/objectTypes"],function(a,b){var c=function(c,d,e){var f,g=c,h=g;if(!g)return h;for(var i=arguments,j=0,k="number"==typeof e?2:i.length;++j<k;)if(g=i[j],g&&b[typeof g])for(var l=-1,m=b[typeof g]&&a(g),n=m?m.length:0;++l<n;)f=m[l],"undefined"==typeof h[f]&&(h[f]=g[f]);return h};return c}),define("plugins/core/commands/indent",[],function(){return function(){return function(a){var b=new a.api.Command("indent");b.queryEnabled=function(){var b=new a.api.Selection,c=b.getContaining(function(a){return"UL"===a.nodeName||"OL"===a.nodeName});return a.api.Command.prototype.queryEnabled.call(this)&&a.allowsBlockElements()&&!c},a.commands.indent=b}}}),define("lodash-modern/utilities/noop",[],function(){function a(){}return a}),define("lodash-modern/internals/baseCreate",["./isNative","../objects/isObject","../utilities/noop"],function(a,b){function c(a){return b(a)?d(a):{}}var d=a(d=Object.create)&&d;return d||(c=function(){function a(){}return function(c){if(b(c)){a.prototype=c;var d=new a;a.prototype=null}return d||window.Object()}}()),c}),define("lodash-modern/internals/setBindData",["./isNative","../utilities/noop"],function(a,b){var c={configurable:!1,enumerable:!1,value:null,writable:!1},d=function(){try{var b={},c=a(c=Object.defineProperty)&&c,d=c(b,b,b)&&c}catch(e){}return d}(),e=d?function(a,b){c.value=b,d(a,"__bindData__",c)}:b;return e}),define("lodash-modern/internals/slice",[],function(){function a(a,b,c){b||(b=0),"undefined"==typeof c&&(c=a?a.length:0);for(var d=-1,e=c-b||0,f=Array(0>e?0:e);++d<e;)f[d]=a[b+d];return f}return a}),define("lodash-modern/internals/baseBind",["./baseCreate","../objects/isObject","./setBindData","./slice"],function(a,b,c,d){function e(e){function f(){if(i){var c=d(i);g.apply(c,arguments)}if(this instanceof f){var e=a(h.prototype),k=h.apply(e,c||arguments);return b(k)?k:e}return h.apply(j,c||arguments)}var h=e[0],i=e[2],j=e[4];return c(f,e),f}var f=[],g=f.push;return e}),define("lodash-modern/internals/baseCreateWrapper",["./baseCreate","../objects/isObject","./setBindData","./slice"],function(a,b,c,d){function e(f){function h(){var c=o?m:this;if(k){var f=d(k);g.apply(f,arguments)}if((l||q)&&(f||(f=d(arguments)),l&&g.apply(f,l),q&&f.length<n))return j|=16,e([i,r?j:-4&j,f,null,m,n]);if(f||(f=arguments),p&&(i=c[s]),this instanceof h){c=a(i.prototype);var t=i.apply(c,f);return b(t)?t:c}return i.apply(c,f)}var i=f[0],j=f[1],k=f[2],l=f[3],m=f[4],n=f[5],o=1&j,p=2&j,q=4&j,r=8&j,s=i;return c(h,f),h}var f=[],g=f.push;return e}),define("lodash-modern/objects/isFunction",[],function(){function a(a){return"function"==typeof a}return a}),define("lodash-modern/internals/createWrapper",["./baseBind","./baseCreateWrapper","../objects/isFunction","./slice"],function(a,b,c,d){function e(f,i,j,k,l,m){var n=1&i,o=2&i,p=4&i,q=16&i,r=32&i;if(!o&&!c(f))throw new TypeError;q&&!j.length&&(i&=-17,q=j=!1),r&&!k.length&&(i&=-33,r=k=!1);var s=f&&f.__bindData__;if(s&&s!==!0)return s=d(s),s[2]&&(s[2]=d(s[2])),s[3]&&(s[3]=d(s[3])),!n||1&s[1]||(s[4]=l),!n&&1&s[1]&&(i|=8),!p||4&s[1]||(s[5]=m),q&&g.apply(s[2]||(s[2]=[]),j),r&&h.apply(s[3]||(s[3]=[]),k),s[1]|=i,e.apply(null,s);var t=1==i||17===i?a:b;return t([f,i,j,k,l,m])}var f=[],g=f.push,h=f.unshift;return e}),define("lodash-modern/functions/bind",["../internals/createWrapper","../internals/slice"],function(a,b){function c(c,d){return arguments.length>2?a(c,17,b(arguments,2),null,d):a(c,1,null,null,d)}return c}),define("lodash-modern/utilities/identity",[],function(){function a(a){return a}return a}),define("lodash-modern/support",["./internals/isNative"],function(a){var b=/\bthis\b/,c={};return c.funcDecomp=!a(window.WinRTError)&&b.test(function(){return this}),c.funcNames="string"==typeof Function.name,c}),define("lodash-modern/internals/baseCreateCallback",["../functions/bind","../utilities/identity","./setBindData","../support"],function(a,b,c,d){function e(e,i,j){if("function"!=typeof e)return b;if("undefined"==typeof i||!("prototype"in e))return e;var k=e.__bindData__;if("undefined"==typeof k&&(d.funcNames&&(k=!e.name),k=k||!d.funcDecomp,!k)){var l=h.call(e);d.funcNames||(k=!f.test(l)),k||(k=g.test(l),c(e,k))}if(k===!1||k!==!0&&1&k[1])return e;switch(j){case 1:return function(a){return e.call(i,a)};case 2:return function(a,b){return e.call(i,a,b)};case 3:return function(a,b,c){return e.call(i,a,b,c)};case 4:return function(a,b,c,d){return e.call(i,a,b,c,d)}}return a(e,i)}var f=/^\s*function[ \n\r\t]+\w/,g=/\bthis\b/,h=Function.prototype.toString;return e}),define("lodash-modern/objects/forIn",["../internals/baseCreateCallback","../internals/objectTypes"],function(a,b){var c=function(c,d,e){var f,g=c,h=g;if(!g)return h;if(!b[typeof g])return h;d=d&&"undefined"==typeof e?d:a(d,e,3);for(f in g)if(d(g[f],f,c)===!1)return h;return h};return c}),define("lodash-modern/internals/arrayPool",[],function(){var a=[];return a}),define("lodash-modern/internals/getArray",["./arrayPool"],function(a){function b(){return a.pop()||[]}return b}),define("lodash-modern/internals/maxPoolSize",[],function(){var a=40;return a}),define("lodash-modern/internals/releaseArray",["./arrayPool","./maxPoolSize"],function(a,b){function c(c){c.length=0,a.length<b&&a.push(c)}return c}),define("lodash-modern/internals/baseIsEqual",["../objects/forIn","./getArray","../objects/isFunction","./objectTypes","./releaseArray"],function(a,b,c,d,e){function f(o,r,s,t,u,v){if(s){var w=s(o,r);if("undefined"!=typeof w)return!!w}if(o===r)return 0!==o||1/o==1/r;var x=typeof o,y=typeof r;if(!(o!==o||o&&d[x]||r&&d[y]))return!1;if(null==o||null==r)return o===r;var z=p.call(o),A=p.call(r);if(z==g&&(z=l),A==g&&(A=l),z!=A)return!1;switch(z){case i:case j:return+o==+r;case k:return o!=+o?r!=+r:0==o?1/o==1/r:o==+r;case m:case n:return o==String(r)}var B=z==h;if(!B){var C=q.call(o,"__wrapped__"),D=q.call(r,"__wrapped__");if(C||D)return f(C?o.__wrapped__:o,D?r.__wrapped__:r,s,t,u,v);if(z!=l)return!1;var E=o.constructor,F=r.constructor;if(E!=F&&!(c(E)&&E instanceof E&&c(F)&&F instanceof F)&&"constructor"in o&&"constructor"in r)return!1}var G=!u;u||(u=b()),v||(v=b());for(var H=u.length;H--;)if(u[H]==o)return v[H]==r;var I=0;if(w=!0,u.push(o),v.push(r),B){if(H=o.length,I=r.length,w=I==H,w||t)for(;I--;){var J=H,K=r[I];if(t)for(;J--&&!(w=f(o[J],K,s,t,u,v)););else if(!(w=f(o[I],K,s,t,u,v)))break}}else a(r,function(a,b,c){return q.call(c,b)?(I++,w=q.call(o,b)&&f(o[b],a,s,t,u,v)):void 0}),w&&!t&&a(o,function(a,b,c){return q.call(c,b)?w=--I>-1:void 0});return u.pop(),v.pop(),G&&(e(u),e(v)),w}var g="[object Arguments]",h="[object Array]",i="[object Boolean]",j="[object Date]",k="[object Number]",l="[object Object]",m="[object RegExp]",n="[object String]",o=Object.prototype,p=o.toString,q=o.hasOwnProperty;return f}),define("lodash-modern/utilities/property",[],function(){function a(a){return function(b){return b[a]}}return a}),define("lodash-modern/functions/createCallback",["../internals/baseCreateCallback","../internals/baseIsEqual","../objects/isObject","../objects/keys","../utilities/property"],function(a,b,c,d,e){function f(f,g,h){var i=typeof f;if(null==f||"function"==i)return a(f,g,h);if("object"!=i)return e(f);var j=d(f),k=j[0],l=f[k];return 1!=j.length||l!==l||c(l)?function(a){for(var c=j.length,d=!1;c--&&(d=b(a[j[c]],f[j[c]],null,!0)););return d}:function(a){var b=a[k];return l===b&&(0!==l||1/l==1/b)}}return f}),define("lodash-modern/arrays/last",["../functions/createCallback","../internals/slice"],function(a,b){function c(c,f,g){var h=0,i=c?c.length:0;if("number"!=typeof f&&null!=f){var j=i;for(f=a(f,g,3);j--&&f(c[j],j,c);)h++}else if(h=f,null==h||g)return c?c[i-1]:d;return b(c,e(0,i-h))}var d,e=Math.max;return c}),define("lodash-modern/internals/baseIndexOf",[],function(){function a(a,b,c){for(var d=(c||0)-1,e=a?a.length:0;++d<e;)if(a[d]===b)return d;return-1}return a}),define("lodash-modern/objects/forOwn",["../internals/baseCreateCallback","./keys","../internals/objectTypes"],function(a,b,c){var d=function(d,e,f){var g,h=d,i=h;if(!h)return i;if(!c[typeof h])return i;e=e&&"undefined"==typeof f?e:a(e,f,3);for(var j=-1,k=c[typeof h]&&b(h),l=k?k.length:0;++j<l;)if(g=k[j],e(h[g],g,d)===!1)return i;return i};return d}),define("lodash-modern/objects/isArray",["../internals/isNative"],function(a){var b="[object Array]",c=Object.prototype,d=c.toString,e=a(e=Array.isArray)&&e,f=e||function(a){return a&&"object"==typeof a&&"number"==typeof a.length&&d.call(a)==b||!1};return f}),define("lodash-modern/objects/isString",[],function(){function a(a){return"string"==typeof a||a&&"object"==typeof a&&d.call(a)==b||!1}var b="[object String]",c=Object.prototype,d=c.toString;return a}),define("lodash-modern/collections/contains",["../internals/baseIndexOf","../objects/forOwn","../objects/isArray","../objects/isString"],function(a,b,c,d){function e(e,g,h){var i=-1,j=a,k=e?e.length:0,l=!1;return h=(0>h?f(0,k+h):h)||0,c(e)?l=j(e,g,h)>-1:"number"==typeof k?l=(d(e)?e.indexOf(g,h):j(e,g,h))>-1:b(e,function(a){return++i>=h?!(l=a===g):void 0}),l}var f=Math.max;return e}),define("plugins/core/commands/insert-html",["lodash-modern/arrays/last","lodash-modern/collections/contains"],function(a,b){return function(){return function(c){function d(a){return b(e,a.nodeName)}var e=["P","LI","DIV","BLOCKQUOTE","UL","OL","H2"],f=new c.api.Command("insertHTML");f.execute=function(b){c.allowsBlockElements()?c.transactionManager.run(function(){function e(b){var c=Array.prototype.reduce.call(b.childNodes,function(b,c){function e(){var a=[c];b.push(a)}var f=a(b);if(f){var g=d(f[0]);g===d(c)?f.push(c):e()}else e();return b},[]),e=c.filter(function(a){var b=d(a[0]);return!b});e.forEach(function(a){var b=document.createElement("p");a[0].parentNode.insertBefore(b,a[0]),a.forEach(function(a){b.appendChild(a)})}),b._isWrapped=!0}function f(a){for(var b=document.createTreeWalker(a,NodeFilter.SHOW_ELEMENT),c=b.firstChild();c;){if("BLOCKQUOTE"===c.nodeName&&!c._isWrapped){e(c),f(a);break}c=b.nextSibling()}}var g=document.createElement("div");g.innerHTML=b,e(g),f(g);var h=g.innerHTML;c.api.Command.prototype.execute.call(this,h)}.bind(this)):c.api.Command.prototype.execute.call(this,b)},c.commands.insertHTML=f}}}),define("plugins/core/commands/insert-list",[],function(){return function(){return function(a){var b=function(b){a.api.Command.call(this,b)};b.prototype=Object.create(a.api.Command.prototype),b.prototype.constructor=b,b.prototype.execute=function(b){function c(a){if(a.length>0){var b=document.createElement(f.nodeName);a.forEach(function(a){b.appendChild(a)}),f.parentNode.insertBefore(b,f.nextElementSibling)}}if(this.queryState()){var d=new a.api.Selection,e=d.range,f=d.getContaining(function(a){return"OL"===a.nodeName||"UL"===a.nodeName}),g=d.getContaining(function(a){return"LI"===a.nodeName});a.transactionManager.run(function(){if(g){var b=new a.api.Node(g).nextAll();c(b),d.placeMarkers();var h=document.createElement("p");h.innerHTML=g.innerHTML,f.parentNode.insertBefore(h,f.nextElementSibling),g.parentNode.removeChild(g)}else{var i=Array.prototype.map.call(f.querySelectorAll("li"),function(a){return e.intersectsNode(a)&&a}).filter(function(a){return a}),j=i.slice(-1)[0],k=new a.api.Node(j).nextAll();c(k),d.placeMarkers();var l=document.createDocumentFragment();i.forEach(function(a){var b=document.createElement("p");b.innerHTML=a.innerHTML,l.appendChild(b)}),f.parentNode.insertBefore(l,f.nextElementSibling),i.forEach(function(a){a.parentNode.removeChild(a)})}0===f.childNodes.length&&f.parentNode.removeChild(f),d.selectMarkers()}.bind(this))}else a.api.Command.prototype.execute.call(this,b)},b.prototype.queryEnabled=function(){return a.api.Command.prototype.queryEnabled.call(this)&&a.allowsBlockElements()},a.commands.insertOrderedList=new b("insertOrderedList"),a.commands.insertUnorderedList=new b("insertUnorderedList")}}}),define("plugins/core/commands/outdent",[],function(){return function(){return function(a){var b=new a.api.Command("outdent");b.queryEnabled=function(){var b=new a.api.Selection,c=b.getContaining(function(a){return"UL"===a.nodeName||"OL"===a.nodeName});return a.api.Command.prototype.queryEnabled.call(this)&&a.allowsBlockElements()&&!c},a.commands.outdent=b}}}),define("plugins/core/commands/redo",[],function(){return function(){return function(a){var b=new a.api.Command("redo");b.execute=function(){var b=a.undoManager.redo();"undefined"!=typeof b&&a.restoreFromHistory(b)},b.queryEnabled=function(){return a.undoManager.position<a.undoManager.stack.length-1},a.commands.redo=b,a.el.addEventListener("keydown",function(a){a.shiftKey&&(a.metaKey||a.ctrlKey)&&90===a.keyCode&&(a.preventDefault(),b.execute())})}}}),define("plugins/core/commands/undo",[],function(){return function(){return function(a){var b=new a.api.Command("undo");b.execute=function(){var b=a.undoManager.undo();"undefined"!=typeof b&&a.restoreFromHistory(b)},b.queryEnabled=function(){return a.undoManager.position>1},a.commands.undo=b,a.el.addEventListener("keydown",function(a){a.shiftKey||!a.metaKey&&!a.ctrlKey||90!==a.keyCode||(a.preventDefault(),b.execute())})}}}),define("plugins/core/commands",["./commands/indent","./commands/insert-html","./commands/insert-list","./commands/outdent","./commands/redo","./commands/undo"],function(a,b,c,d,e,f){return{indent:a,insertHTML:b,insertList:c,outdent:d,redo:e,undo:f}}),define("plugins/core/events",["lodash-modern/collections/contains"],function(a){return function(){return function(b){b.allowsBlockElements()&&b.el.addEventListener("keydown",function(a){if(13===a.keyCode){var c=new b.api.Selection,d=c.range,e=c.getContaining(function(a){return/^(H[1-6])$/.test(a.nodeName)});if(e&&d.collapsed){var f=d.cloneRange();f.setEndAfter(e,0);var g=f.cloneContents();""===g.firstChild.textContent&&(a.preventDefault(),b.transactionManager.run(function(){var a=document.createElement("p"),b=document.createElement("br");a.appendChild(b),e.parentNode.insertBefore(a,e.nextElementSibling),d.setStart(a,0),d.setEnd(a,0),c.selection.removeAllRanges(),c.selection.addRange(d)}))}}}),b.allowsBlockElements()&&b.el.addEventListener("keydown",function(a){if(13===a.keyCode||8===a.keyCode){var c=new b.api.Selection,d=c.range;if(d.collapsed){var e=c.getContaining(function(a){return"LI"===a.nodeName});if(e&&""===e.textContent.trim()){a.preventDefault();var f=c.getContaining(function(a){return"UL"===a.nodeName||"OL"===a.nodeName}),g=b.getCommand("OL"===f.nodeName?"insertOrderedList":"insertUnorderedList");g.execute()}}}}),b.el.addEventListener("paste",function(c){if(c.clipboardData)c.preventDefault(),a(c.clipboardData.types,"text/html")?b.insertHTML(c.clipboardData.getData("text/html")):b.insertPlainText(c.clipboardData.getData("text/plain"));else{var d=new b.api.Selection;d.placeMarkers();var e=document.createElement("div");document.body.appendChild(e),e.setAttribute("contenteditable",!0),e.focus(),setTimeout(function(){data=e.innerHTML,e.parentNode.removeChild(e),d.selectMarkers(),b.el.focus(),b.insertHTML(data)},1)}})}}}),define("plugins/core/formatters/html/replace-nbsp-chars",[],function(){return function(){return function(a){var b="&nbsp;| ",c=new RegExp(b,"g");a.htmlFormatter.formatters.push(function(a){return a.replace(c," ")})}}}),define("lodash-modern/internals/htmlEscapes",[],function(){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return a}),define("lodash-modern/internals/escapeHtmlChar",["./htmlEscapes"],function(a){function b(b){return a[b]}return b}),define("lodash-modern/internals/reUnescapedHtml",["./htmlEscapes","../objects/keys"],function(a,b){var c=RegExp("["+b(a).join("")+"]","g");return c}),define("lodash-modern/utilities/escape",["../internals/escapeHtmlChar","../objects/keys","../internals/reUnescapedHtml"],function(a,b,c){function d(b){return null==b?"":String(b).replace(c,a)}return d}),define("plugins/core/formatters/plain-text/escape-html-characters",["lodash-modern/utilities/escape"],function(a){return function(){return function(b){b.plainTextFormatter.formatters.push(a)}}}),define("plugins/core/inline-elements-mode",[],function(){function a(a){for(var b=document.createTreeWalker(a);b.nextNode();)if(b.currentNode&&(~["br"].indexOf(b.currentNode.nodeName.toLowerCase())||b.currentNode.length>0))return!0;return!1}return function(){return function(b){b.el.addEventListener("keydown",function(c){if(13===c.keyCode){var d=new b.api.Selection,e=d.range,f=d.getContaining(function(a){return"LI"===a.nodeName||/^(H[1-6])$/.test(a.nodeName)});f||(c.preventDefault(),b.transactionManager.run(function(){"BR"===b.el.lastChild.nodeName&&b.el.removeChild(b.el.lastChild);var c=document.createElement("br");e.insertNode(c),e.collapse(!1);var f=e.cloneRange();f.setEndAfter(b.el.lastChild,0);var g=f.cloneContents();if(!a(g)){var h=document.createElement("br");e.insertNode(h)}var i=e.cloneRange();i.setStartAfter(c,0),i.setEndAfter(c,0),d.selection.removeAllRanges(),d.selection.addRange(i)}))}}.bind(this)),""===b.getHTML().trim()&&b.setContent("")}}}),define("plugins/core/patches/commands/bold",[],function(){return function(){return function(a){var b=new a.api.CommandPatch("bold");b.queryEnabled=function(){var b=new a.api.Selection,c=b.getContaining(function(a){return/^(H[1-6])$/.test(a.nodeName)});return a.api.CommandPatch.prototype.queryEnabled.apply(this,arguments)&&!c},a.commandPatches.bold=b}}}),define("plugins/core/patches/commands/indent",[],function(){var a="﻿";return function(){return function(b){var c=new b.api.CommandPatch("indent");c.execute=function(c){b.transactionManager.run(function(){var d=new b.api.Selection,e=d.range,f="P"===e.commonAncestorContainer.nodeName&&"<br>"===e.commonAncestorContainer.innerHTML;if(f){var g=document.createTextNode(a);e.insertNode(g),e.setStart(g,0),e.setEnd(g,0),d.selection.removeAllRanges(),d.selection.addRange(e)}b.api.CommandPatch.prototype.execute.call(this,c),d=new b.api.Selection;var h=d.getContaining(function(a){return"BLOCKQUOTE"===a.nodeName});h&&h.removeAttribute("style")}.bind(this))},b.commandPatches.indent=c}}}),define("plugins/core/patches/commands/insert-html",[],function(){return function(){return function(a){var b=new a.api.CommandPatch("insertHTML");b.execute=function(b){a.transactionManager.run(function(){function c(b){var d=document.createTreeWalker(b,NodeFilter.SHOW_ELEMENT),e=d.firstChild();if(e)do"SPAN"===e.nodeName?new a.api.Element(b).unwrap(e):(e.style.lineHeight=null,""===e.getAttribute("style")&&e.removeAttribute("style")),c(e);while(e=d.nextSibling())}a.api.CommandPatch.prototype.execute.call(this,b),c(a.el)}.bind(this))},a.commandPatches.insertHTML=b}}}),define("plugins/core/patches/commands/insert-list",[],function(){return function(){return function(a){var b=function(b){a.api.CommandPatch.call(this,b)};b.prototype=Object.create(a.api.CommandPatch.prototype),b.prototype.constructor=b,b.prototype.execute=function(b){a.transactionManager.run(function(){if(a.api.CommandPatch.prototype.execute.call(this,b),this.queryState()){var c=new a.api.Selection,d=c.getContaining(function(a){return"OL"===a.nodeName||"UL"===a.nodeName});if(d){var e=d.parentNode;e&&/^(H[1-6]|P)$/.test(e.nodeName)&&(c.placeMarkers(),e.parentNode.insertBefore(d,e.nextElementSibling),c.selectMarkers(),e.parentNode.removeChild(e))}var f=Array.prototype.slice.call(d.childNodes);f.forEach(function(b){var c=Array.prototype.slice.call(b.childNodes);c.forEach(function(c){if("SPAN"===c.nodeName){var d=c;new a.api.Element(b).unwrap(d)}else c.nodeType===Node.ELEMENT_NODE&&(c.style.lineHeight=null,""===c.getAttribute("style")&&c.removeAttribute("style"))})})}}.bind(this))},a.commandPatches.insertOrderedList=new b("insertOrderedList"),a.commandPatches.insertUnorderedList=new b("insertUnorderedList")}}}),define("plugins/core/patches/commands/outdent",[],function(){return function(){return function(a){var b=new a.api.CommandPatch("outdent");b.execute=function(){a.transactionManager.run(function(){var b=new a.api.Selection,c=b.range;if("BLOCKQUOTE"===c.commonAncestorContainer.nodeName){var d=c.commonAncestorContainer;b.placeMarkers(),b.selectMarkers(!0);var e=c.cloneContents();d.parentNode.insertBefore(e,d),c.deleteContents(),b.selectMarkers(),""===d.textContent&&d.parentNode.removeChild(d)}else{var f=b.getContaining(function(a){return"P"===a.nodeName});if(f){var d=b.getContaining(function(a){return"BLOCKQUOTE"===a.nodeName}),g=new a.api.Node(f).nextAll();if(g.length){var h=document.createElement(d.nodeName);g.forEach(function(a){h.appendChild(a)}),d.parentNode.insertBefore(h,d.nextElementSibling)}b.placeMarkers(),d.parentNode.insertBefore(f,d.nextElementSibling),b.selectMarkers(),""===d.innerHTML&&d.parentNode.removeChild(d)}else a.api.CommandPatch.prototype.execute.call(this)}}.bind(this))},a.commandPatches.outdent=b}}}),define("plugins/core/patches/empty-when-deleting",[],function(){return function(){return function(a){function b(a){var b=document.createElement("div"),c=a.cloneContents();return b.appendChild(c),b.innerHTML}function c(c){var d=b(c),e=document.createRange();e.selectNodeContents(a.el);var f=b(e);return d===f}a.el.addEventListener("keydown",function(b){if(8===b.keyCode||46===b.keyCode){var d=new a.api.Selection,e=d.selection.isCollapsed,f=c(d.range);(e&&""===a.getTextContent().trim()||!e&&f)&&(b.preventDefault(),a.transactionManager.run(function(){a.setHTML('<p><em class="scribe-marker"></em><br></p>'),d.selectMarkers()}))}})}}}),define("plugins/core/patches/events",[],function(){return function(){return function(a){a.allowsBlockElements()&&a.el.addEventListener("keyup",function(b){if(8===b.keyCode||46===b.keyCode){var c=new a.api.Selection;c.range;var d=c.getContaining(function(a){return"P"===a.nodeName});d&&(a.undoManager.undo(),a.transactionManager.run(function(){c.placeMarkers();var b=Array.prototype.slice.call(d.childNodes);b.forEach(function(b){if("SPAN"===b.nodeName){var c=b;new a.api.Element(d).unwrap(c)}else b.nodeType===Node.ELEMENT_NODE&&(b.style.lineHeight=null,""===b.getAttribute("style")&&b.removeAttribute("style"))}),c.selectMarkers()}))}})}}}),define("plugins/core/patches",["./patches/commands/bold","./patches/commands/indent","./patches/commands/insert-html","./patches/commands/insert-list","./patches/commands/outdent","./patches/empty-when-deleting","./patches/events"],function(a,b,c,d,e,f,g){return{commands:{bold:a,indent:b,insertHTML:c,insertList:d,outdent:e},emptyWhenDeleting:f,events:g}}),define("plugins/core/set-root-p-element",[],function(){return function(){return function(a){""===a.getHTML().trim()&&a.setContent("<p><br></p>")}}}),define("api/command-patch",[],function(){return function(a){function b(a){this.commandName=a}return b.prototype.execute=function(b){a.transactionManager.run(function(){document.execCommand(this.commandName,!1,b||null)}.bind(this))},b.prototype.queryState=function(){return document.queryCommandState(this.commandName)},b.prototype.queryEnabled=function(){return document.queryCommandEnabled(this.commandName)},b}}),define("api/command",[],function(){return function(a){function b(b){this.commandName=b,this.patch=a.commandPatches[this.commandName]}return b.prototype.execute=function(b){this.patch?this.patch.execute(b):a.transactionManager.run(function(){document.execCommand(this.commandName,!1,b||null)}.bind(this))},b.prototype.queryState=function(){return this.patch?this.patch.queryState():document.queryCommandState(this.commandName)},b.prototype.queryEnabled=function(){return this.patch?this.patch.queryEnabled():document.queryCommandEnabled(this.commandName)},b}}),define("api/node",[],function(){function a(a){this.node=a}return a.prototype.getAncestor=function(a){var b=function(a){return a&&a.attributes&&a.attributes.getNamedItem("contenteditable")};if(!b(this.node))for(var c=this.node.parentNode;c&&!b(c);){if(a(c))return c;c=c.parentNode}},a.prototype.nextAll=function(){for(var a=[],b=this.node;b=b.nextSibling;)a.push(b);return a},a}),define("api/element",["./node"],function(a){function b(b){a.call(this,b)}return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.unwrap=function(a){for(;a.childNodes.length>0;)this.node.insertBefore(a.childNodes[0],a);this.node.removeChild(a)},b}),define("api/selection",[],function(){return function(a){function b(){this.selection=window.getSelection(),this.selection.rangeCount&&(this.range=this.selection.getRangeAt(0))}return b.prototype.getContaining=function(b){var c=new a.api.Node(this.range.commonAncestorContainer),d=c.node&&c.node.attributes&&c.node.attributes.getNamedItem("contenteditable");return!d&&b(c.node)?c.node:c.getAncestor(b)},b.prototype.placeMarkers=function(){var a=document.createElement("em");a.classList.add("scribe-marker");var b=document.createElement("em");b.classList.add("scribe-marker");var c=this.range.cloneRange();if(c.collapse(!1),c.insertNode(b),b.nextSibling&&3===b.nextSibling.nodeType&&""===b.nextSibling.data&&b.parentNode.removeChild(b.nextSibling),!this.range.collapsed){var d=this.range.cloneRange();d.collapse(!0),d.insertNode(a),a.nextSibling&&3===a.nextSibling.nodeType&&""===a.nextSibling.data&&a.parentNode.removeChild(a.nextSibling)}this.selection.removeAllRanges(),this.selection.addRange(this.range)},b.prototype.getMarkers=function(){return a.el.querySelectorAll("em.scribe-marker")},b.prototype.removeMarkers=function(){var a=this.getMarkers();Array.prototype.forEach.call(a,function(a){a.parentNode.removeChild(a)})},b.prototype.selectMarkers=function(a){var b=this.getMarkers();b.length&&(this.range.setStartBefore(b[0]),b.length>=2?this.range.setEndAfter(b[1]):this.range.setEndAfter(b[0]),a||this.removeMarkers(),this.selection.removeAllRanges(),this.selection.addRange(this.range))},b.prototype.isCaretOnNewLine=function(){var a=this.getContaining(function(a){return"P"===a.nodeName});if(a){var b=a.innerHTML.trim();return"P"===a.nodeName&&("<br>"===b||""===b)}return!1},b}}),define("api/simple-command",[],function(){return function(a,b){function c(a,c){b.api.Command.call(this,a),this.nodeName=c}return c.prototype=Object.create(a.Command.prototype),c.prototype.constructor=c,c.prototype.queryState=function(){var a=new b.api.Selection;return b.api.Command.prototype.queryState.call(this)&&!!a.getContaining(function(a){return a.nodeName===this.nodeName}.bind(this))},c}}),define("api",["./api/command-patch","./api/command","./api/element","./api/node","./api/selection","./api/simple-command"],function(a,b,c,d,e,f){return function(g){this.CommandPatch=a(g),this.Command=b(g),this.Element=c,this.Node=d,this.Selection=e(g),this.SimpleCommand=f(this,g)}}),define("lodash-modern/objects/assign",["../internals/baseCreateCallback","./keys","../internals/objectTypes"],function(a,b,c){var d=function(d,e,f){var g,h=d,i=h;if(!h)return i;var j=arguments,k=0,l="number"==typeof f?2:j.length;if(l>3&&"function"==typeof j[l-2])var m=a(j[--l-1],j[l--],2);else l>2&&"function"==typeof j[l-1]&&(m=j[--l]);for(;++k<l;)if(h=j[k],h&&c[typeof h])for(var n=-1,o=c[typeof h]&&b(h),p=o?o.length:0;++n<p;)g=o[n],i[g]=m?m(i[g],h[g]):h[g];return i};return d}),define("transaction-manager",["lodash-modern/objects/assign"],function(a){return function(b){function c(){this.history=[]}return a(c.prototype,{start:function(){this.history.push(1)},end:function(){this.history.pop(),0===this.history.length&&(b.pushHistory(),b.trigger("content-changed"))},run:function(a){this.start();try{a&&a()}finally{this.end()}}}),c}}),define("undo-manager",[],function(){return function(a){function b(){this.position=0,this.stack=[],this.debug=a.isDebugModeEnabled()}return b.prototype.maxStackSize=100,b.prototype.push=function(a){for(this.debug&&console.log("UndoManager.push: %s",a),this.stack.length=++this.position,this.stack.push(a);this.stack.length>this.maxStackSize;)this.stack.shift(),--this.position},b.prototype.undo=function(){return this.position>1?this.stack[--this.position]:void 0},b.prototype.redo=function(){return this.position<this.stack.length-1?this.stack[++this.position]:void 0},b}}),define("scribe",["event-emitter","lodash-modern/objects/defaults","./plugins/core/commands","./plugins/core/events","./plugins/core/formatters/html/replace-nbsp-chars","./plugins/core/formatters/plain-text/escape-html-characters","./plugins/core/inline-elements-mode","./plugins/core/patches","./plugins/core/set-root-p-element","./api","./transaction-manager","./undo-manager"],function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a,m){this.el=a,this.commands={},this.options=b(m||{},{allowBlockElements:!0,debug:!1}),this.commandPatches={},this.plainTextFormatter=new n,this.htmlFormatter=new n,this.api=new j(this);
var o=k(this);this.transactionManager=new o;var p=l(this);this.undoManager=new p,this.el.setAttribute("contenteditable",!0),this.el.addEventListener("input",function(){this.transactionManager.run()}.bind(this),!1),this.allowsBlockElements()?this.use(i()):this.use(g()),this.use(f()),this.use(e()),this.use(h.commands.bold()),this.use(h.commands.indent()),this.use(h.commands.insertHTML()),this.use(h.commands.insertList()),this.use(h.commands.outdent()),this.allowsBlockElements()&&this.use(h.emptyWhenDeleting()),this.use(h.events()),this.use(c.indent()),this.use(c.insertHTML()),this.use(c.insertList()),this.use(c.outdent()),this.use(c.redo()),this.use(c.undo()),this.use(d());var q=function(){setTimeout(function(){this.pushHistory()}.bind(this),0),this.el.removeEventListener("focus",q)}.bind(this);this.el.addEventListener("focus",function(){function a(b){var c=document.createTreeWalker(b),d=c.currentNode;return c.firstChild()?"BR"===c.currentNode.nodeName?d:a(c.currentNode):c.currentNode}var b=new this.api.Selection;if(b.range){b.placeMarkers();var c=this.allowsBlockElements()&&this.getHTML().match(/^<em class="scribe-marker"><\/em>/);if(b.removeMarkers(),c){var d=a(this.el.firstChild),e=b.range;e.setStart(d,0),e.setEnd(d,0),b.selection.removeAllRanges(),b.selection.addRange(e)}}}.bind(this)),this.el.addEventListener("focus",q)}function n(){this.formatters=[]}return m.prototype=Object.create(a.prototype),m.prototype.use=function(a){return a(this),this},m.prototype.setHTML=function(a){this.el.innerHTML=a},m.prototype.getHTML=function(){return this.el.innerHTML},m.prototype.getContent=function(){return this.getHTML().replace(/<br>$/,"")},m.prototype.getTextContent=function(){return this.el.textContent},m.prototype.pushHistory=function(){var a=this.undoManager.stack[this.undoManager.position],b=a&&a.replace(/<em class="scribe-marker">/g,"").replace(/<\/em>/g,"");if(!a||a&&this.getContent()!==b){var c=new this.api.Selection;c.placeMarkers();var d=this.getHTML();return c.removeMarkers(),this.undoManager.push(d),!0}return!1},m.prototype.getCommand=function(a){return this.commands[a]||this.commandPatches[a]||new this.api.Command(a)},m.prototype.restoreFromHistory=function(a){this.setHTML(a);var b=new this.api.Selection;b.selectMarkers(),this.trigger("content-changed")},m.prototype.allowsBlockElements=function(){return this.options.allowBlockElements},m.prototype.setContent=function(a){this.allowsBlockElements()||(a+="<br>"),this.setHTML(this.htmlFormatter.format(a)),this.trigger("content-changed")},m.prototype.insertPlainText=function(a){this.insertHTML("<p>"+this.plainTextFormatter.format(a)+"</p>")},m.prototype.insertHTML=function(a){this.getCommand("insertHTML").execute(this.htmlFormatter.format(a))},m.prototype.isDebugModeEnabled=function(){return this.options.debug},n.prototype.format=function(a){var b=this.formatters.reduce(function(a,b){return b(a)},a);return b},m}),function(a){"use strict";var b=b||function(){};a.Editor=b}(this);